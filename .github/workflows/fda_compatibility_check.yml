name: FDA Compatibility Check

on:
  schedule:
    # Run daily at 6 AM UTC to check if FDA site is still compatible
    - cron: '0 6 * * *'
  workflow_dispatch:  # Allow manual triggering
  push:
    branches: [ main, master ]
    paths:
      - 'src/pymaude/**'
      - 'archive_tools/check_fda_compatibility.py'
      - '.github/workflows/fda_compatibility_check.yml'

jobs:
  check-compatibility:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .

    - name: Run FDA compatibility check
      id: compatibility_check
      continue-on-error: true
      run: |
        python archive_tools/check_fda_compatibility.py --json > compatibility_results.json
        echo "exit_code=$?" >> $GITHUB_OUTPUT

    - name: Parse results
      id: parse_results
      run: |
        # Extract compatibility status from JSON
        compatible=$(jq -r '.compatible' compatibility_results.json)
        timestamp=$(jq -r '.timestamp' compatibility_results.json)
        error_count=$(jq -r '.errors | length' compatibility_results.json)
        warning_count=$(jq -r '.warnings | length' compatibility_results.json)

        echo "compatible=$compatible" >> $GITHUB_OUTPUT
        echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
        echo "error_count=$error_count" >> $GITHUB_OUTPUT
        echo "warning_count=$warning_count" >> $GITHUB_OUTPUT

        # Create badge color and message
        if [ "$compatible" = "true" ]; then
          echo "badge_color=brightgreen" >> $GITHUB_OUTPUT
          echo "badge_message=compatible" >> $GITHUB_OUTPUT
          echo "badge_status=passing" >> $GITHUB_OUTPUT
        else
          echo "badge_color=red" >> $GITHUB_OUTPUT
          echo "badge_message=incompatible" >> $GITHUB_OUTPUT
          echo "badge_status=failing" >> $GITHUB_OUTPUT
        fi

    - name: Create compatibility badge
      uses: schneegans/dynamic-badges-action@v1.7.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: 2be19fadf256e3b5de290996b99b1f19
        filename: pymaude_fda_compatibility.json
        label: FDA Site
        message: ${{ steps.parse_results.outputs.badge_message }}
        color: ${{ steps.parse_results.outputs.badge_color }}

    - name: Upload compatibility results
      uses: actions/upload-artifact@v4
      with:
        name: compatibility-results
        path: compatibility_results.json
        retention-days: 90

    - name: Create issue on failure
      if: steps.parse_results.outputs.compatible == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const results = JSON.parse(fs.readFileSync('compatibility_results.json', 'utf8'));

          // Check if an issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['fda-compatibility', 'automated']
          });

          if (issues.data.length === 0) {
            // Create new issue
            const errorList = results.errors.map(e => `- ${e}`).join('\n');
            const warningList = results.warnings.map(w => `- ${w}`).join('\n');

            const issueBody = `## FDA MAUDE Site Compatibility Issue Detected

          The automated compatibility check has detected that the FDA MAUDE website is no longer compatible with the PyMAUDE library.

          **Timestamp:** ${results.timestamp}

          ### Errors (${results.errors.length})
          ${errorList || 'None'}

          ### Warnings (${results.warnings.length})
          ${warningList || 'None'}

          ### Check Results
          \`\`\`json
          ${JSON.stringify(results.checks, null, 2)}
          \`\`\`

          ### Action Required
          1. Review the compatibility check results
          2. Investigate changes to the FDA MAUDE website
          3. Update the PyMAUDE library code to handle the new format
          4. Update documentation if URL patterns have changed
          5. Consider creating an archived version on Zenodo if this is a major change

          ### Artifacts
          Full compatibility check results are available in the workflow artifacts.

          ---
          *This issue was automatically created by the FDA Compatibility Check workflow.*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® FDA MAUDE Site Compatibility Issue - ${new Date().toISOString().split('T')[0]}`,
              body: issueBody,
              labels: ['fda-compatibility', 'automated', 'bug']
            });
          }

    - name: Comment on existing issue if now passing
      if: steps.parse_results.outputs.compatible == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // Check if an issue exists and close it with a comment
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['fda-compatibility', 'automated']
          });

          if (issues.data.length > 0) {
            for (const issue of issues.data) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: `‚úÖ FDA MAUDE site compatibility has been restored. The compatibility check is now passing.\n\nTimestamp: ${new Date().toISOString()}`
              });

              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
          }

    - name: Fail workflow if incompatible
      if: steps.parse_results.outputs.compatible == 'false'
      run: |
        echo "‚ùå FDA MAUDE site is incompatible with PyMAUDE library"
        echo "Errors: ${{ steps.parse_results.outputs.error_count }}"
        echo "Warnings: ${{ steps.parse_results.outputs.warning_count }}"
        exit 1
